#!/bin/bash
# LaTeX PDF Generation Script
# Usage: scripts/tex2pdf [--check | --install | --clean | --help]

set -e           # Exit immediately if a command exits with a non-zero status
set -o pipefail  # Return value of a pipeline is the value of the last (failed) command

# name of the main tex file
MAIN_FILE="main"
# directory where the script runs
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Logic to source bash_messages
if [ -f "$SCRIPT_DIR/bash_messages" ]; then
    source "$SCRIPT_DIR/bash_messages"
else
  echo "bash_messages missing"
  exit 1
fi

# show the usage of the script
usage() {
  echo "Usage: $0 [--build|--check | --install | --clean | -h|--help]"
  exit 0
}

# cleans aux and log files
clean_artifacts() {
    warn "Cleaning build artifacts..."
    rm -f *.aux *.bbl *.blg *.log *.out *.toc *.lof *.lot *.xdv *.fls *.fdb_latexmk
}

# Checks for binaries and the specific font
check_dependencies() {
    local missing=0
    action "Checking system requirements..."

    # Check binaries
    for tool in xelatex bibtex fc-list; do
        if command -v "$tool" &> /dev/null; then
            success "Tool found: $tool"
        else
            error "Missing tool: $tool" 0
            missing=1
        fi
    done

    # Check Font
    action "Verifying Font Configuration..."

    # We use -i for case insensitive and search strictly for "dejavu"
    if fc-list | grep -qi "dejavu"; then
        success "Font found: DejaVu"
    else
        warn "Font 'DejaVu' not found via standard check."
        warn "Debug Info:"
        warn "  Which fc-list: $(which fc-list)"
        warn "  Font output sample: $(fc-list | head -n 3)"

        error "Font: DejaVu Sans (Required)" 0
        missing=1
    fi

    if [ $missing -eq 1 ]; then
        echo ""
        warn "Dependencies missing. Run 'scripts/tex2pdf --install' to fix."
        return 1
    fi
    success "All dependencies met."
    return 0
}

# Installs texlive and the specific fonts
install_dependencies() {
    action "Installing dependencies..."

    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS installation
        if command -v port &> /dev/null; then
            action "Detected MacPorts. Installing TeXLive and Fonts..."

            # Use sudo to install packages
            sudo port -N install texlive-xetex texlive-latex-extra texlive-fonts-recommended dejavu-fonts fontconfig

            # --- MACPORTS FONT CONFIGURATION ---
            # 1. Create local config to point to standard MacPorts font path
            if [ -d "/opt/local/share/fonts" ]; then
                action "Configuring ~/.config/fontconfig/fonts.conf..."
                mkdir -p ~/.config/fontconfig
                cat <<EOF > ~/.config/fontconfig/fonts.conf
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
    <!-- Explicitly add MacPorts font directory -->
    <dir>/opt/local/share/fonts</dir>
</fontconfig>
EOF
            fi

            # 2. Force cache rebuild
            action "Rebuilding font cache (this may take a moment)..."
            if [ -x "/opt/local/bin/fc-cache" ]; then
                /opt/local/bin/fc-cache -f -v
            else
                fc-cache -f -v
            fi

        elif command -v brew &> /dev/null; then
            action "Detected Homebrew..."
            brew install --cask mactex-no-gui font-dejavu
            brew install texlive
        else
            error "No package manager found (MacPorts/Homebrew). Install manually."
        fi
    else
        # Linux (Debian/Ubuntu)
        action "Detected Linux (apt)..."
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-latex-extra fonts-dejavu fonts-dejavu-extra fontconfig
        fc-cache -f -v
    fi

    success "Installation complete. Run 'scripts/tex2pdf --check' to verify."
}

# the core functionality
build_pdf() {
    if [ ! -f "${MAIN_FILE}.tex" ]; then
        error "${MAIN_FILE}.tex not found."
    fi

    # Clean before building
    clean_artifacts

    action "Building ${MAIN_FILE}..."

    # 1. First Pass
    action ">> XeLaTeX Pass 1..."
    xelatex -interaction=nonstopmode "${MAIN_FILE}.tex"

    # 2. Bibtex
    if [ -f references.bib ] || [ -f "${MAIN_FILE}.bib" ]; then
        action ">> BibTeX..."
        bibtex "${MAIN_FILE}"
    fi

    # 3. Second Pass
    action ">> XeLaTeX Pass 2..."
    xelatex -interaction=nonstopmode "${MAIN_FILE}.tex" > /dev/null

    # 4. Final Pass
    action ">> XeLaTeX Pass 3 (Final)..."
    xelatex -interaction=nonstopmode "${MAIN_FILE}.tex" > /dev/null

    if [ -f "${MAIN_FILE}.pdf" ]; then
        success "Build successful: ${MAIN_FILE}.pdf"
    else
        error "Build failed. Check ${MAIN_FILE}.log for details."
    fi
}

# Command Line argument handling

# if no arguments then try building the pdf file
if [ $# -eq 0 ]; then
    build_pdf
    exit 0
fi

# if arguments are available
while [[ $# -gt 0 ]]; do
    case "$1" in
        --build)
           build_pdf
           ;;
        --check)
            check_dependencies
            exit $?
            ;;
        --install)
            install_dependencies
            exit $?
            ;;
        --clean)
            clean_artifacts
            exit 0
            ;;
        -h|--help)
            usage
            ;;
        *)
            error "Unknown argument: $1"
            ;;
    esac
    shift
done
